Это файл контекста для всех языковых моделей, работающих с этим репозиторием. Эту строку стирать нельзя.

Кодировка: все файлы должны быть в UTF-8 без BOM. BOM запрещен, он ломает обработку.

Язык общения: предпочтительно русский. Комментарии в коде — на английском.

# Контекст проекта

## Обзор
Проект `lcmm-event-bus` — in-process шина событий на Clojure для архитектуры LCMM (Loosely Coupled Modular Monolith).
Ключевая идея: разделение на синхронный Critical Path (бизнес-транзакции) и асинхронный Reactive Path (побочные эффекты).

## Архитектурные принципы
- Модули общаются только через события (envelopes), без прямых вызовов.
- Причинность отслеживается через `CorrelationID` и `CausationPath`.
- Цепочки ограничены по глубине (`max-depth`), и есть детекция циклов.

## Ключевые файлы
- `src/event_bus.clj` — реализация шины.
- `test/event_bus_test.clj` — тесты.
- `docs/ARCH.md`, `docs/REQUIREMENTS.md`, `docs/BUS.md`, `docs/LOGGING.md` — документация.
- `docs/TODO.md` — список критических проблем/рисков.
- `docs/OUTBOX_INBOX.md` — описание outbox+inbox.
- `tests.edn`, `test.bat` — запуск тестов.

## Важные текущие правила и изменения
- `publish` требует обязательный `:module` в opts.
- `CausationPath` хранится как вектор пар `[module event-type]`.
- Цикл детектируется по повтору пары `(module, event-type)`.
- `log!` не должен ломать критический путь: исключения логгера подавляются.
- В buffered-режиме consumers запускаются в virtual threads через `executor`.
- В `make-bus` обязателен `:schema-registry` (map of versions); `publish` валидирует строго и падает при отсутствии/невалидности схемы.
- `publish` поддерживает `:schema-version` (по умолчанию "1.0").

## Тесты
- Запуск: `test.bat`.
- В тестах есть сценарии, фиксирующие известные проблемы из `docs/TODO.md`.

## Возможное будущее
- Опциональная поддержка брокера может быть реализована как новый транспортный backend при сохранении API; изменения для пользователей должны сводиться к конфигурации `make-bus`.

## Практические соглашения
- Все файлы сохранять строго в UTF-8 без BOM.
- Русский язык в общении. Комментарии в коде — на английском.
