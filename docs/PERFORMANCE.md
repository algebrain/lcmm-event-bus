# PERFORMANCE

Рекомендации по производительности `event-bus`.

## Общие принципы

- **Отделяйте критический путь от фонового.** Тяжелые операции (HTTP, почта, сложная агрегация) — только в обработчиках, а не в синхронном пути.
- **Держите payload компактным.** Валидация схем и сериализация быстрее на небольших данных.
- **Измеряйте на целевом железе.** Латентность и p99 зависят от JVM, I/O и CPU.

## Режимы шины

### `:unlimited`

- Максимальная простота и минимальная латентность.
- Подходит, когда нагрузка умеренная или вы готовы масштабироваться за счет ресурсов JVM.

### `:buffered`

- Нужен для защиты от всплесков нагрузки и backpressure.
- Важно подобрать `:buffer-size` и `:concurrency`:
  - `:buffer-size` слишком малый → частые `buffer full`.
  - слишком большой → память и задержки при всплесках.
  - `:concurrency` подбирайте по числу CPU и типу задач.

## Настройки `publish`

- Валидация схем `publish` обязательна: если критично, делайте схемы максимально простыми.
- В `subscribe` используйте `:schema` только там, где нужна защита — это добавляет проверку на каждом событии.

## Настройки `transact`

`transact` дороже, т.к. использует внутреннюю БД и фоновые обработчики.

Рекомендации:

- Используйте `transact` только для операций, где действительно нужна согласованность.
- Снижайте `:handler-max-retries` и увеличивайте `:handler-backoff-ms`, если важнее стабильность, чем скорость.
- `:tx-handler-timeout` держите минимально разумным, чтобы не копить “зависшие” обработчики.

## SQLite (внутренняя БД)

По умолчанию уже включены быстрые PRAGMA:

- `journal_mode=WAL`
- `synchronous=NORMAL`
- `foreign_keys=ON`
- `temp_store=MEMORY`

Если нужно быстрее:

- Используйте быстрый локальный SSD.
- Держите базу на локальном диске (не сетевой путь).
- Избегайте параллельных тяжёлых транзакций в этой же БД.

## Datahike

- Подходит для сценариев, где нужна гибкость, но может быть медленнее в простом in‑memory режиме.
- Для критичных метрик сравнивайте `:sqlite` и `:datahike` на своих нагрузках.

## Очистка данных `transact`

- Включена по умолчанию для `:ok` транзакций:
  - `:tx-retention-ms` — срок хранения (по умолчанию 7 дней).
  - `:tx-cleanup-interval-ms` — периодичность очистки (по умолчанию 1 час).
- Если база растет слишком быстро, уменьшайте срок хранения.

## Бенчмарки

Используйте `bench.bb` для проверки реальных показателей:

```powershell
bb bench.bb
```

Параметры смотрите в `docs/BENCH.md`.

## Что измерять в проде

Минимальный набор метрик:

- Latency p50/p95/p99 для `publish`.
- Latency p50/p95/p99 для полного `transact` цикла.
- Кол-во ошибок обработчиков и ретраев.
- В buffered режиме — частоту `buffer full`.
