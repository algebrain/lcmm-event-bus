# Inbox + Outbox

Этот документ описывает технологию Inbox + Outbox для повышения надежности обработки событий в асинхронной архитектуре.

## Зачем это нужно
В in-process шине события живут в памяти процесса. При падении приложения возможны потери:
- событие не успели опубликовать (между коммитом и publish),
- событие опубликовали, но обработчик упал до завершения работы.

Связка Inbox + Outbox решает обе проблемы и позволяет сохранить согласованность между модулями в условиях сбоев.

## Outbox (у отправителя)
Идея: запись бизнес-данных и запись события делаются в одной транзакции.

Минимальная схема таблицы outbox:
- event_id (UUID)
- event_type (keyword/string)
- payload (json/edn)
- correlation_id
- causation_path (ordered list of [module event-type])
- schema_version
- status (pending | sent)
- created_at

Поток:
1) Транзакция: записать бизнес-данные и событие в outbox.
2) Фоновый воркер читает pending и публикует в шину.
3) После успешного publish помечает запись как sent (или удаляет).

Гарантия: событие не потеряется между коммитом и публикацией.

## Inbox (у получателя)
Идея: получатель фиксирует факт получения события до выполнения бизнес-логики.

Минимальная схема таблицы inbox:
- event_id (UUID)
- event_type
- correlation_id
- received_at
- status (received | processed)

Поток:
1) Обработчик получает событие.
2) В транзакции: записать event_id в inbox, выполнить бизнес-изменения, пометить processed.
3) Если событие приходит повторно (дедупликация по event_id), обработчик не выполняется снова.

Гарантия: падение обработчика не приводит к потере события — оно будет обработано при повторной доставке.

## Совместный эффект
- Outbox гарантирует доставку события в шину.
- Inbox гарантирует доставку события до обработки.
- Вместе это дает at-least-once доставку с идемпотентной обработкой.

## Ограничения и ожидания
- Сильная консистентность в реальном времени все равно недостижима без синхронной координации.
- Нужно проектировать обработчики идемпотентными.
- Возможны повторы событий — это нормальная часть модели.

## Минимальные шаги внедрения
1) Добавить таблицы outbox/inbox в БД модулей.
2) Из критического пути убрать прямой publish и писать в outbox.
3) Добавить воркер, публикующий pending события.
4) В обработчиках внедрить inbox-дедупликацию по event_id.
