# Требования к `event-bus`

## 1. Сообщение как «Конверт» (Envelope)
Шина оперирует иммутабельными структурами (Map) с обязательным набором метаданных:

- `MessageID`: Уникальный GUID для каждого сообщения (дедупликация).
- `CorrelationID`: Сквозной идентификатор всей бизнес-цепочки (Саги).
- `CausationPath`: Упорядоченный список пар `(Module, MessageType)`, породивших данное сообщение.
- `Module`: Идентификатор модуля-инициатора (keyword).
- `SchemaVersion`: Версия структуры данных для безболезненного обновления компонентов.
- `MessageType`: Тип данного сообщения, который при создании порожденного сообщения записывается в `CausationPath`.

## 2. Использование `CorrelationID`, `CausationPath`, `MessageType` и `Module`
Эти поля должны использоваться "под капотом" при порождении нового сообщения на основе пришедшего.

## 3. Причинно-следственный контроль (Causality)
Шина — это «умный» фильтр, который проверяет каждое сообщение перед публикацией:

- **Детекция циклов:** Если пара `(Module, MessageType)` уже присутствует в `CausationPath`, шина бросает исключение (Fail-fast).
- **Лимит прыжков (TTL):** Принудительная остановка цепочки, если стек `CausationPath` превысил заданный порог (например, 20 шагов).

## 4. Режим «Unlimited Async» (по умолчанию)
Основной режим работы, ориентированный на максимальную отзывчивость:

- Каждое сообщение немедленно порождает новый Виртуальный поток (требует Java 21+).
- Потоки не блокируют друг друга. Если один обработчик «завис» на IO, остальные продолжают работу.

## 5. Режим «Buffered Async» (опционально)
Режим защиты системы от перегрузок (Backpressure):

- Сообщения не создают поток сразу, а попадают в `ArrayBlockingQueue` заданного размера.
- Из этой очереди сообщения достает фиксированный пул виртуальных потоков.
- Если очередь заполнена, шина бросает исключение.

**ВНИМАНИЕ!** Синхронный режим нужно убрать из кода шины совсем. (Это требование выполнено).

## 6. Строгие контракты (Malli)
Шина — это «таможня» для данных: валидация схем на входе (`publish`) и на выходе (`subscribe`). Гарантия того, что в шине нет «мусорных» данных с битыми ключами или типами.

### Канонический реестр схем
- Реестр схем обязателен и передается при создании шины.
- Формат: `event-type -> {schema-version -> schema}`.
- Режим strict: если схемы нет или payload невалиден, `publish` бросает исключение.

## 7. Прозрачность (Observability)
Возможность восстановить ход событий:

- Логирование каждого шага с сохранением `CorrelationID`.
- Возможность построить граф вызовов (кто кого породил) на основе `CausationPath`.
