# Логирование и Наблюдаемость (Observability)

`event-bus` предоставляет механизм для логирования своей внутренней работы, что критически важно для отладки и анализа поведения системы.

## Подключение логгера

При создании экземпляра шины через `make-bus` можно передать опцию `:logger`.

`:logger` — это функция, которая принимает два аргумента:
1.  `level` — уровень логирования (ключевое слово, например, `:info`, `:warn`, `:error`).
2.  `data` — карта с данными о событии.

```clojure
(require '[clojure.tools.logging :as log])

(def my-logger
  (fn [level data]
    (case level
      :info  (log/info data)
      :warn  (log/warn data)
      :error (log/error data))))

(def bus (bus/make-bus {:logger my-logger}))
```

## Структура логов

Шина генерирует несколько типов событий, которые попадают в логгер. Все они содержат ключ `:event`, описывающий тип записи.

### `:event-published`
- **Уровень:** `:info`
- **Когда:** Генерируется каждый раз при вызове `publish`.
- **Данные:** Содержит полный `envelope` опубликованного сообщения.
- **Польза:** Позволяет увидеть абсолютно все события, проходящие через шину.

### `:event-persisted`
- **Уровень:** `:info`
- **Когда:** Сообщение сохранено в хранилище в долговременном режиме.
- **Данные:** Включают `message-id`, `message-type`.
- **Польза:** Подтверждает, что событие записано и не потеряется после падения процесса.

### `:schema-validation-failed`
- **Уровень:** `:warn`
- **Когда:** Если подписчик использует `:schema` и полезная нагрузка (`payload`) не проходит валидацию.
- **Данные:** Включают `event-type`, `correlation-id`, `payload` и `:errors` с деталями ошибки валидации от `malli`.
- **Польза:** Помогает быстро выявлять компоненты, отправляющие данные в неверном формате.

### `:publish-schema-missing`
- **Уровень:** `:error`
- **Когда:** В режиме strict, если для `event-type` и `schema-version` отсутствует схема в реестре.
- **Данные:** Включают `event-type`, `schema-version`.
- **Польза:** Показывает, что событие не зарегистрировано в каноническом реестре.

### `:publish-schema-validation-failed`
- **Уровень:** `:error`
- **Когда:** В режиме strict, если payload не проходит валидацию в `publish`.
- **Данные:** Включают `event-type`, `schema-version`, `correlation-id`, `payload`, `errors`.
- **Польза:** Раннее выявление некорректных данных на входе в шину.

### `:handler-failed`
- **Уровень:** `:error`
- **Когда:** Если во время выполнения функции-обработчика происходит исключение.
- **Данные:** Включают `:exception` с объектом исключения.
- **Польза:** Изолирует и сообщает об ошибках в подписчиках, не останавливая работу всей шины.

### `:buffer-full`
- **Уровень:** `:error`
- **Когда:** В режиме `:buffered`, если очередь событий переполнена и новое событие не может быть принято.
- **Польза:** Сигнализирует о системной перегрузке (backpressure).

### `:event-dispatched`
- **Уровень:** `:info`
- **Когда:** Сообщение из долговременного хранилища отправлено в шину.
- **Данные:** Включают `message-id`, `message-type`.
- **Польза:** Подтверждает успешную доставку.

### `:event-dispatch-failed`
- **Уровень:** `:error`
- **Когда:** Ошибка при доставке сообщения из хранилища.
- **Данные:** Включают `message-id`, `message-type`, `attempts`, `exception`.
- **Польза:** Помогает отслеживать проблемы доставки.

### `:event-dispatch-give-up`
- **Уровень:** `:error`
- **Когда:** Достигнут лимит попыток доставки.
- **Данные:** Включают `message-id`, `message-type`, `attempts`.
- **Польза:** Сигнализирует о необходимости ручного вмешательства.

### `:dispatcher-crash`
- **Уровень:** `:error`
- **Когда:** Фоновый исполнитель доставки завершился с ошибкой.
- **Данные:** Включают `exception`.
- **Польза:** Указывает на сбой в механизме доставки.

### `:bus-closing`, `:bus-closed`, `:shutdown-timeout`
- **Уровень:** `:info` или `:warn`
- **Когда:** Генерируются во время штатного завершения работы шины через `close`.
- **Польза:** Помогают отслеживать жизненный цикл шины.
