# Логирование и Наблюдаемость (Observability)

`event-bus` предоставляет механизм для логирования своей внутренней работы, что критически важно для отладки и анализа поведения системы.

## Подключение логгера

При создании экземпляра шины через `make-bus` можно передать опцию `:logger`.

`:logger` — это функция, которая принимает два аргумента:
1.  `level` — уровень логирования (ключевое слово, например, `:info`, `:warn`, `:error`).
2.  `data` — карта с данными о событии.

```clojure
(require '[clojure.tools.logging :as log])

(def my-logger
  (fn [level data]
    (case level
      :info  (log/info data)
      :warn  (log/warn data)
      :error (log/error data))))

(def bus (bus/make-bus {:logger my-logger}))
```

## Структура логов

Шина генерирует несколько типов событий, которые попадают в логгер. Все они содержат ключ `:event`, описывающий тип записи.

### `:event-published`
- **Уровень:** `:info`
- **Когда:** Генерируется каждый раз при вызове `publish`.
- **Данные:** Содержит полный `envelope` опубликованного сообщения.
- **Польза:** Позволяет увидеть абсолютно все события, проходящие через шину.

### `:schema-validation-failed`
- **Уровень:** `:warn`
- **Когда:** Если подписчик использует `:schema` и полезная нагрузка (`payload`) не проходит валидацию.
- **Данные:** Включают `event-type`, `correlation-id`, `payload` и `:errors` с деталями ошибки валидации от `malli`.
- **Польза:** Помогает быстро выявлять компоненты, отправляющие данные в неверном формате.

### `:handler-failed`
- **Уровень:** `:error`
- **Когда:** Если во время выполнения функции-обработчика происходит исключение.
- **Данные:** Включают `:exception` с объектом исключения.
- **Польза:** Изолирует и сообщает об ошибках в подписчиках, не останавливая работу всей шины.

### `:buffer-full`
- **Уровень:** `:error`
- **Когда:** В режиме `:buffered`, если очередь событий переполнена и новое событие не может быть принято.
- **Польза:** Сигнализирует о системной перегрузке (backpressure).

### `:bus-closing`, `:bus-closed`, `:shutdown-timeout`
- **Уровень:** `:info` или `:warn`
- **Когда:** Генерируются во время штатного завершения работы шины через `close`.
- **Польза:** Помогают отслеживать жизненный цикл шины.
