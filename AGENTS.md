# Руководство по репозиторию

## Структура проекта и организация модулей

`src/` содержит основной код библиотеки (основное пространство имён — `event-bus` в `src/event_bus.clj`).  
`test/` содержит unit‑тесты (например, `test/event_bus_test.clj`).  
`docs/` содержит документацию для пользователя библиотеки: архитектурные заметки, API‑документацию и требования к поведению. Эти документы могут содержать детали реализации шины, но лишь в том случае если это необходимо для разъяснения каких-либо вопросов, важных для пользователя библиотеки
Когда вы просите создать план работ, документ плана должен быть размещён в `.plans/` и начинаться с `YYYY-MM-DD_`.  
Когда вы просите сохранить ответ, он должен быть размещён в `.answers/` и начинаться с `YYYY-MM-DD_`.  
Обе директории перечислены в `.gitignore` и не должны коммититься.  
Если нужно создать нестандартные файлы или папки, которые не должны попадать в git, их имена можно заканчивать на `.local` или `.local.*` — такие файлы и папки будут отсеяны через `.gitignore`.  
Используйте `README.md` как точку входа, затем следуйте ссылкам в `docs/` для подробностей.

## Команды сборки, тестирования и разработки

Это библиотека на Clojure без отдельных скриптов сборки/запуска. Основной рабочий процесс — тесты:

- `clj -M:test`  
  Запускает полный набор тестов через Kaocha, согласно `tests.edn`.
- `.\test.bat`  
  Windows‑хелпер, запускающий тесты с documentation reporter.

Если нужен REPL, используйте предпочитаемый `clj`‑запуск и загрузите namespace `event-bus`.

## Стиль кода и соглашения об именовании

Все файлы должны сохраняться в UTF‑8 без BOM. BOM запрещён.  
Для файловых операций (чтение/запись) использовать Python вместо PowerShell, чтобы избежать проблем с кодировкой.  
Коммуникация предпочтительна на русском; комментарии в коде — на английском.  
Следуйте идиоматическому форматированию Clojure: отступ 2 пробела, выравнивание карт и биндингов, держите чистые функции небольшими.  
Имена namespace — kebab-case (`event-bus`), имена файлов — с подчёркиваниями (`event_bus.clj`).  
Ключевые слова используют формат `:domain/name` или `:module/name` (например, `:test/event`).

В репозитории нет форматтера или линтера; сохраняйте текущий стиль и избегайте переформатирования несвязанных участков кода.

## Поведение и архитектурные заметки

Шина работает in-process и построена вокруг envelope‑сообщений. Эти правила должны оставаться неизменными:

- `publish` требует `:module` в opts.
- `:schema-registry` обязателен в `make-bus`; `publish` строго валидирует и падает при отсутствии/невалидности схем.
- `:schema-version` по умолчанию равен `"1.0"`.
- `CausationPath` — вектор пар `[module event-type]` с детекцией циклов.
- Ошибки логгера не должны ломать критический путь.
- В буферизованном режиме consumers запускаются на виртуальных потоках через общий executor.

## Руководство по тестированию

Запускайте тесты через `.\test.bat` в Windows.
Тесты выполняются через Kaocha.  
Тестовые файлы лежат в `test/` и используют namespace с суффиксом `*-test` (например, `event-bus-test`).  
Явной цели по покрытию нет; добавляйте тесты для нового поведения и краевых случаев, особенно вокруг причинности и валидации схем.

Цикл тестирование‑правки начинать с тройного бипа — его делать только перед запуском первого теста в цикле. Перед каждым последующим запуском тестов в том же цикле — одинарный бип.

## Рекомендации по коммитам и pull request

История коммитов содержит короткие описательные сообщения (например, "README fix", "significant changes in code and documentation").  
Строгого стандарта нет, но коммиты должны быть краткими и сфокусированными на одном изменении.

Для pull request включайте:

- Краткое описание изменений поведения.
- Команды тестов и их результаты.
- Обновления в `README.md`, `docs/` при изменении поведения или API.

## Точки обновления документации

Если вы меняете публичный API или поведение, обновите `docs/BUS.md`, `docs/ARCH.md` (и английские варианты, если есть) и синхронизируйте `README.md`.
